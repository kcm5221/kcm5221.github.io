<!DOCTYPE html>
<html lang="ko">
<head>
    <title>점프 장애물 & 지면 히트박스 충돌 로직 적용</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../../css/Style1.css" />
    <link rel="icon" href="../../../image/favicon.ico" type="image/x-icon">
</head>
<body>
    <div id="header"></div>
    <div class="content-wrapper">
        <nav id="nav"></nav>
        <main>
            <h1>점프 장애물 & 지면 히트박스 충돌 로직 적용</h1>
            <div class="post-meta">2025.09.09</div>
            <br />

            <h2>1. 개념 정리</h2>
            <p>
                세로형 러너에서 <strong>점프로만 회피 가능한 장애물</strong>을 자연스럽게 만들기 위해,
                충돌을 단순 2D 겹침이 아닌 <strong>지면 기준(ground) 논리</strong>로 해석했다.
                핵심은 다음과 같다.
            </p>
            <ul>
                <li><strong>점프 배리어(barrierFull)</strong>: 3레인 전체를 가로막는 낮은 벽. 점프로만 통과 가능.</li>
                <li><strong>지면 히트박스(groundHitbox)</strong>: 점프 전 기준 위치(<code>baseY</code>)를 중심으로 한 플레이어의 바닥 기준 히트박스.</li>
                <li><strong>공중 상태(airborne)</strong>: 플레이어가 <code>baseY</code>에서 일정 픽셀 이상 떠 있으면 배리어와의 충돌을 무시.</li>
                <li><strong>깊이 값 <code>t</code></strong>: 0(수평선)~1(바닥) 사이의 <em>사용자 정의 깊이</em>로, 실제 y좌표/스케일/도로폭은 <code>t</code>를 통해 계산된다.</li>
                <li><strong>스폰 간섭 방지</strong>: 장애물 간 깊이(<code>t</code>) 거리 규칙으로 겹치기/난잡함 방지.</li>
                <li><strong>도로 표현</strong>: 기존 세그먼트 스트라이프 대신, <em>연속 대시(점선)</em>를 독립 위상으로 흘려보내어 장애물과의 박자를 분리.</li>
            </ul>

            <h2>2. 구현한 내용</h2>
            <ol>
                <li>
                    <strong>Obstacle.js</strong> – 배리어/큐브 충돌 판정 정리
                    <ul>
                        <li><code>kind: 'cube' | 'barrierFull'</code> 사용(현 구조 유지).</li>
                        <li><code>barrierFull</code>은 현재 화면 y에서의 도로폭에 맞춰 가로폭 자동 조정, 세로는 얇은 띠 유지.</li>
                        <li>배리어의 충돌은 바닥쪽 얇은 스트립만 사용해 “점프로 넘기”를 보장(<code>getHitbox()</code>).</li>
                    </ul>
                </li>

                <li>
                    <strong>Player.js</strong> – 지면 히트박스 & 공중 판정 + 컨트롤 보정
                    <ul>
                        <li><code>getGroundHitbox()</code>: <code>baseY</code> 중심의 지면 기준 히트박스 반환.</li>
                        <li><code>getLiftPx()</code> &amp; <code>isAirborne()</code>: 화면상 상승 픽셀로 공중 상태 판단.</li>
                        <li><strong>점프 중 레인 이동 금지:</strong> <code>moveLane()</code>에서 <code>isAirborne()</code>일 경우 입력 무시.</li>
                    </ul>
                </li>

                <li>
                    <strong>GameScene</strong> – 스폰/충돌 로직 보강 + <strong>모듈화 + 밸런스 단일화</strong>
                    <ul>
                        <li><code>canSpawnAt(t, lane, isFull)</code>로 장애물 간 <code>t</code> 최소 간격 규칙 적용.</li>
                        <li><code>spawnObstacle()</code>에서 전레인 배리어를 확률적으로 섞되, 간섭 시 스킵.</li>
                        <li>충돌 루프에서 <strong>배리어는 공중이면 무시</strong>, 지면 기준 히트박스로만 판정.</li>
                        <li>
                            <em>구조 개선(모듈화)</em>: <code>GameScene</code>은 상태/전환 위주로 두고, 아래 시스템으로 역할 분리.
                            <br><code>/src/systems/DepthMapper.js</code> – <code>t↔y</code>, 도로폭, 스케일, 레인X
                            <br><code>/src/systems/ParallaxBackground.js</code> – 패럴럭스 배경
                            <br><code>/src/systems/RoadRenderer.js</code> – 도로 연속 대시 렌더링
                            <br><code>/src/systems/Spawner.js</code> – 스폰/간격 검사(<code>canSpawnAt</code>)
                            <br><code>/src/systems/CollisionSystem.js</code> – 브로드+정밀 충돌
                            <br><code>/src/systems/InputManager.js</code> – 키/스와이프 입력
                            <br><code>/src/systems/DebugDraw.js</code> – 히트박스 디버그
                        </li>
                        <li><strong>밸런스 수치 단일화:</strong> <code>/src/config/gameConfig.js</code>에 속도, 가속, 스폰 간격, 배리어 확률, 점수 증가율, 도로 대시 간격·지터 등을 모아 관리.</li>
                        <li>엔티티 호환을 위해 <code>GameScene</code>에는 <code>yFromT/scaleAtY/roadWidthAt/getLaneXAtScreenY</code> 포워더와 <code>vanishX</code>, <code>depthSpan</code>이 유지된다.</li>
                    </ul>
                </li>
            </ol>

            <h2>3. 문제 해결 및 개선</h2>
            <p><strong>점프해도 배리어에 무조건 충돌하던 문제</strong></p>
            <ul>
                <li><strong>원인:</strong> 단일 직사각형 겹침만 사용해 “높이(z) 개념”이 반영되지 않음.</li>
                <li><strong>해결:</strong> 지면 기준 히트박스 + 공중 판정으로 점프 중 배리어 충돌 무시.</li>
            </ul>

            <p><strong>장애물 겹침/난잡한 화면</strong></p>
            <ul>
                <li><strong>원인:</strong> 깊이(<code>t</code>) 간 간격 없이 무작위 생성.</li>
                <li><strong>해결:</strong> <code>canSpawnAt()</code>로 전레인 배리어/일반 장애물 각각 최소 간격 규칙 적용.</li>
            </ul>

            <p><strong>도로/장애물 리듬 동기화로 인한 어지러움</strong></p>
            <ul>
                <li><strong>원인:</strong> 세그먼트 기반 도로 스트라이프와 장애물이 같은 <code>t</code> 축으로 움직임.</li>
                <li><strong>해결:</strong> 도로를 단색 폴리곤으로 채우고, 레인 점선은 별도 위상/지터로 흐르게 변경 → 장애물과 비동기화되어 덜 어지럽고 자연스러움.</li>
            </ul>

            <p><strong>점프 중 레인 이동 무시</strong></p>
            <ul>
                <li><strong>원인:</strong> 점프 상태에서도 <code>moveLane()</code>이 실행됨.</li>
                <li><strong>해결:</strong> <code>isAirborne()</code> 체크로 점프 중에는 이동 입력 무시.</li>
            </ul>

            <p><strong>개발자 튜닝의 불편함</strong></p>
            <ul>
                <li><strong>원인:</strong> 수치가 여러 파일에 분산.</li>
                <li><strong>해결:</strong> <code>gameConfig.js</code>에 모든 밸런스 수치를 통합해 한 곳에서 관리.</li>
            </ul>

            <br /><br />
            <div class="post-meta"><a href="./NemoRun01.html">NemoRun</a></div>
            <br />
        </main>
        <aside id="aside"></aside>
    </div>
    <div id="footer"></div>

    <script src="../../../js/includehtml.js"></script>
    <script src="../../../js/MoveAside.js"></script>
</body>
</html>
